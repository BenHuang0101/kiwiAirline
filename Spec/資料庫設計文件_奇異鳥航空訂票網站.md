# 奇異鳥航空訂票網站 - 資料庫設計文件

## 文件資訊

- **文件名稱：** 奇異鳥航空訂票網站 資料庫設計文件
- **版本：** v1.0
- **撰寫人：** SA
- **日期：** 2025-07-17
- **文件狀態：** Draft

---

## 資料庫概述

### 資料庫類型

- **資料庫系統：** MySQL 8.0
- **字元集：** UTF8MB4
- **排序規則：** utf8mb4_unicode_ci
- **時區：** UTC

### 命名規則

- 資料表名稱使用複數形式，小寫加底線 (例：users, flight_bookings)
- 欄位名稱使用小寫加底線 (例：created_at, first_name)
- 主鍵統一使用 id
- 外鍵使用 {table_name}\_id 格式
- 索引名稱使用 idx*{table}*{column} 格式

---

## 實體關係圖（ERD）概述

### 主要實體及關係

```
Users (用戶)
  ↓ 1:N
Bookings (訂單)
  ↓ 1:N
BookingPassengers (訂單乘客)
  ↓ N:1
Passengers (乘客)

Flights (航班)
  ↓ 1:N
Bookings (訂單)

Payments (付款)
  ↓ 1:1
Bookings (訂單)

SupportTickets (客服工單)
  ↓ N:1
Users (用戶)
```

### 關係說明

1. **用戶與訂單：** 一對多關係，一個用戶可以有多個訂單
2. **航班與訂單：** 一對多關係，一個航班可以有多個訂單
3. **訂單與乘客：** 多對多關係，透過 booking_passengers 中間表實現
4. **訂單與付款：** 一對一關係，每個訂單對應一筆付款記錄
5. **用戶與客服工單：** 一對多關係，一個用戶可以提交多個客服工單

---

## 資料表設計

### 1. 資料表 users（用戶表）

**用途：** 儲存用戶帳戶資訊

| 欄位名稱      | 資料型別  | 長度 | PK  | NULL | 預設值            | 說明                   |
| ------------- | --------- | ---- | --- | ---- | ----------------- | ---------------------- |
| id            | CHAR      | 36   | Y   | N    | UUID()            | 用戶唯一識別碼（UUID） |
| first_name    | VARCHAR   | 50   |     | N    | -                 | 姓氏                   |
| last_name     | VARCHAR   | 50   |     | N    | -                 | 名字                   |
| email         | VARCHAR   | 100  |     | N    | -                 | 電子郵件（唯一）       |
| password_hash | VARCHAR   | 255  |     | N    | -                 | 加密後的密碼           |
| phone_number  | VARCHAR   | 15   |     | Y    | NULL              | 手機號碼               |
| is_active     | BOOLEAN   | -    |     | N    | TRUE              | 帳戶是否啟用           |
| last_login_at | TIMESTAMP | -    |     | Y    | NULL              | 最後登入時間           |
| created_at    | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 建立時間               |
| updated_at    | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 更新時間（ON UPDATE）  |

**索引：**

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_users_email` (`email`)
- KEY `idx_users_phone` (`phone_number`)
- KEY `idx_users_created_at` (`created_at`)

---

### 2. 資料表 flights（航班表）

**用途：** 儲存航班基本資訊

| 欄位名稱          | 資料型別  | 長度 | PK  | NULL | 預設值            | 說明                  |
| ----------------- | --------- | ---- | --- | ---- | ----------------- | --------------------- |
| id                | CHAR      | 36   | Y   | N    | UUID()            | 航班唯一識別碼        |
| flight_number     | VARCHAR   | 10   |     | N    | -                 | 航班號碼（例：KW001） |
| departure_airport | VARCHAR   | 3    |     | N    | -                 | 出發機場代碼（IATA）  |
| arrival_airport   | VARCHAR   | 3    |     | N    | -                 | 抵達機場代碼（IATA）  |
| departure_time    | DATETIME  | -    |     | N    | -                 | 出發時間              |
| arrival_time      | DATETIME  | -    |     | N    | -                 | 抵達時間              |
| aircraft_model    | VARCHAR   | 50   |     | Y    | NULL              | 飛機型號              |
| total_seats       | INT       | -    |     | N    | -                 | 總座位數              |
| available_seats   | INT       | -    |     | N    | -                 | 可用座位數            |
| base_price        | DECIMAL   | 10,2 |     | N    | -                 | 基本票價              |
| currency          | VARCHAR   | 3    |     | N    | 'TWD'             | 幣別                  |
| status            | ENUM      | -    |     | N    | 'scheduled'       | 航班狀態              |
| gate              | VARCHAR   | 10   |     | Y    | NULL              | 登機門                |
| terminal          | VARCHAR   | 10   |     | Y    | NULL              | 航廈                  |
| created_at        | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 建立時間              |
| updated_at        | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 更新時間              |

**ENUM 值說明：**

- status: 'scheduled', 'boarding', 'departed', 'arrived', 'cancelled', 'delayed'

**索引：**

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_flights_number` (`flight_number`)
- KEY `idx_flights_departure` (`departure_airport`, `departure_time`)
- KEY `idx_flights_route` (`departure_airport`, `arrival_airport`)
- KEY `idx_flights_status` (`status`)

---

### 3. 資料表 passengers（乘客表）

**用途：** 儲存乘客基本資訊（可重複使用）

| 欄位名稱        | 資料型別  | 長度 | PK  | NULL | 預設值            | 說明               |
| --------------- | --------- | ---- | --- | ---- | ----------------- | ------------------ |
| id              | CHAR      | 36   | Y   | N    | UUID()            | 乘客唯一識別碼     |
| first_name      | VARCHAR   | 50   |     | N    | -                 | 姓氏               |
| last_name       | VARCHAR   | 50   |     | N    | -                 | 名字               |
| passport_number | VARCHAR   | 20   |     | N    | -                 | 護照號碼           |
| date_of_birth   | DATE      | -    |     | N    | -                 | 出生日期           |
| nationality     | VARCHAR   | 2    |     | N    | -                 | 國籍（ISO 3166-1） |
| gender          | ENUM      | -    |     | Y    | NULL              | 性別               |
| email           | VARCHAR   | 100  |     | Y    | NULL              | 電子郵件           |
| phone_number    | VARCHAR   | 15   |     | Y    | NULL              | 電話號碼           |
| created_at      | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 建立時間           |
| updated_at      | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 更新時間           |

**ENUM 值說明：**

- gender: 'M', 'F', 'OTHER'

**索引：**

- PRIMARY KEY (`id`)
- KEY `idx_passengers_passport` (`passport_number`)
- KEY `idx_passengers_name` (`first_name`, `last_name`)

---

### 4. 資料表 bookings（訂單表）

**用途：** 儲存訂票訂單主要資訊

| 欄位名稱          | 資料型別  | 長度 | PK  | FK  | NULL | 預設值            | 說明                      |
| ----------------- | --------- | ---- | --- | --- | ---- | ----------------- | ------------------------- |
| id                | CHAR      | 36   | Y   |     | N    | UUID()            | 訂單唯一識別碼            |
| booking_number    | VARCHAR   | 20   |     |     | N    | -                 | 訂單編號（對外顯示）      |
| user_id           | CHAR      | 36   |     | Y   | N    | -                 | 用戶 ID（FK: users.id）   |
| flight_id         | CHAR      | 36   |     | Y   | N    | -                 | 航班 ID（FK: flights.id） |
| status            | ENUM      | -    |     |     | N    | 'pending'         | 訂單狀態                  |
| passenger_count   | INT       | -    |     |     | N    | -                 | 乘客人數                  |
| total_amount      | DECIMAL   | 10,2 |     |     | N    | -                 | 總金額                    |
| currency          | VARCHAR   | 3    |     |     | N    | 'TWD'             | 幣別                      |
| contact_email     | VARCHAR   | 100  |     |     | N    | -                 | 聯絡人電子郵件            |
| contact_phone     | VARCHAR   | 15   |     |     | N    | -                 | 聯絡人電話                |
| booking_date      | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 訂票時間                  |
| confirmation_code | VARCHAR   | 10   |     |     | Y    | NULL              | 確認碼                    |
| notes             | TEXT      | -    |     |     | Y    | NULL              | 備註                      |
| created_at        | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 建立時間                  |
| updated_at        | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 更新時間                  |

**ENUM 值說明：**

- status: 'pending', 'confirmed', 'cancelled', 'modified', 'completed'

**索引：**

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_bookings_number` (`booking_number`)
- KEY `fk_bookings_user` (`user_id`)
- KEY `fk_bookings_flight` (`flight_id`)
- KEY `idx_bookings_status` (`status`)
- KEY `idx_bookings_date` (`booking_date`)

**外鍵約束：**

- FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE RESTRICT
- FOREIGN KEY (`flight_id`) REFERENCES `flights`(`id`) ON DELETE RESTRICT

---

### 5. 資料表 booking_passengers（訂單乘客關聯表）

**用途：** 管理訂單與乘客的多對多關係，並儲存座位資訊

| 欄位名稱      | 資料型別  | 長度 | PK  | FK  | NULL | 預設值            | 說明                         |
| ------------- | --------- | ---- | --- | --- | ---- | ----------------- | ---------------------------- |
| id            | CHAR      | 36   | Y   |     | N    | UUID()            | 關聯記錄唯一識別碼           |
| booking_id    | CHAR      | 36   |     | Y   | N    | -                 | 訂單 ID（FK: bookings.id）   |
| passenger_id  | CHAR      | 36   |     | Y   | N    | -                 | 乘客 ID（FK: passengers.id） |
| seat_number   | VARCHAR   | 5    |     |     | Y    | NULL              | 座位號碼（例：12A）          |
| ticket_number | VARCHAR   | 15   |     |     | Y    | NULL              | 電子機票號碼                 |
| check_in_time | TIMESTAMP | -    |     |     | Y    | NULL              | 報到時間                     |
| boarding_pass | VARCHAR   | 255  |     |     | Y    | NULL              | 登機證檔案路徑               |
| created_at    | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 建立時間                     |

**索引：**

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_booking_passenger` (`booking_id`, `passenger_id`)
- KEY `fk_booking_passengers_booking` (`booking_id`)
- KEY `fk_booking_passengers_passenger` (`passenger_id`)
- KEY `idx_booking_passengers_ticket` (`ticket_number`)

**外鍵約束：**

- FOREIGN KEY (`booking_id`) REFERENCES `bookings`(`id`) ON DELETE CASCADE
- FOREIGN KEY (`passenger_id`) REFERENCES `passengers`(`id`) ON DELETE RESTRICT

---

### 6. 資料表 payments（付款表）

**用途：** 儲存付款交易資訊

| 欄位名稱         | 資料型別  | 長度 | PK  | FK  | NULL | 預設值            | 說明                       |
| ---------------- | --------- | ---- | --- | --- | ---- | ----------------- | -------------------------- |
| id               | CHAR      | 36   | Y   |     | N    | UUID()            | 付款唯一識別碼             |
| booking_id       | CHAR      | 36   |     | Y   | N    | -                 | 訂單 ID（FK: bookings.id） |
| transaction_id   | VARCHAR   | 50   |     |     | Y    | NULL              | 第三方交易 ID              |
| payment_method   | ENUM      | -    |     |     | N    | -                 | 付款方式                   |
| amount           | DECIMAL   | 10,2 |     |     | N    | -                 | 付款金額                   |
| currency         | VARCHAR   | 3    |     |     | N    | 'TWD'             | 幣別                       |
| status           | ENUM      | -    |     |     | N    | 'pending'         | 付款狀態                   |
| gateway_response | JSON      | -    |     |     | Y    | NULL              | 金流回應資料               |
| card_last_four   | VARCHAR   | 4    |     |     | Y    | NULL              | 信用卡後四碼               |
| card_brand       | VARCHAR   | 20   |     |     | Y    | NULL              | 信用卡品牌                 |
| processed_at     | TIMESTAMP | -    |     |     | Y    | NULL              | 處理完成時間               |
| refunded_amount  | DECIMAL   | 10,2 |     |     | N    | 0.00              | 已退款金額                 |
| refunded_at      | TIMESTAMP | -    |     |     | Y    | NULL              | 退款時間                   |
| created_at       | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 建立時間                   |
| updated_at       | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 更新時間                   |

**ENUM 值說明：**

- payment_method: 'credit_card', 'debit_card', 'atm_transfer', 'bank_transfer'
- status: 'pending', 'processing', 'completed', 'failed', 'cancelled', 'refunded'

**索引：**

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_payments_booking` (`booking_id`)
- KEY `idx_payments_transaction` (`transaction_id`)
- KEY `idx_payments_status` (`status`)
- KEY `idx_payments_method` (`payment_method`)

**外鍵約束：**

- FOREIGN KEY (`booking_id`) REFERENCES `bookings`(`id`) ON DELETE RESTRICT

---

### 7. 資料表 support_tickets（客服工單表）

**用途：** 儲存客服問題與處理記錄

| 欄位名稱       | 資料型別  | 長度 | PK  | FK  | NULL | 預設值            | 說明                    |
| -------------- | --------- | ---- | --- | --- | ---- | ----------------- | ----------------------- |
| id             | CHAR      | 36   | Y   |     | N    | UUID()            | 工單唯一識別碼          |
| ticket_number  | VARCHAR   | 20   |     |     | N    | -                 | 工單編號（對外顯示）    |
| user_id        | CHAR      | 36   |     | Y   | Y    | NULL              | 用戶 ID（FK: users.id） |
| booking_id     | CHAR      | 36   |     | Y   | Y    | NULL              | 相關訂單 ID             |
| category       | ENUM      | -    |     |     | N    | -                 | 問題分類                |
| subject        | VARCHAR   | 200  |     |     | N    | -                 | 問題主旨                |
| description    | TEXT      | -    |     |     | N    | -                 | 問題描述                |
| priority       | ENUM      | -    |     |     | N    | 'medium'          | 優先級                  |
| status         | ENUM      | -    |     |     | N    | 'open'            | 處理狀態                |
| assigned_agent | VARCHAR   | 50   |     |     | Y    | NULL              | 分配客服人員            |
| contact_name   | VARCHAR   | 100  |     |     | N    | -                 | 聯絡人姓名              |
| contact_email  | VARCHAR   | 100  |     |     | N    | -                 | 聯絡人電子郵件          |
| contact_phone  | VARCHAR   | 15   |     |     | Y    | NULL              | 聯絡人電話              |
| resolution     | TEXT      | -    |     |     | Y    | NULL              | 解決方案                |
| resolved_at    | TIMESTAMP | -    |     |     | Y    | NULL              | 解決時間                |
| created_at     | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 建立時間                |
| updated_at     | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 更新時間                |

**ENUM 值說明：**

- category: 'booking', 'payment', 'flight', 'refund', 'technical', 'general'
- priority: 'low', 'medium', 'high', 'urgent'
- status: 'open', 'in_progress', 'waiting_customer', 'resolved', 'closed'

**索引：**

- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_tickets_number` (`ticket_number`)
- KEY `fk_tickets_user` (`user_id`)
- KEY `fk_tickets_booking` (`booking_id`)
- KEY `idx_tickets_status` (`status`)
- KEY `idx_tickets_category` (`category`)
- KEY `idx_tickets_priority` (`priority`)

**外鍵約束：**

- FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE SET NULL
- FOREIGN KEY (`booking_id`) REFERENCES `bookings`(`id`) ON DELETE SET NULL

---

### 8. 資料表 faq（常見問題表）

**用途：** 儲存系統常見問題與解答

| 欄位名稱   | 資料型別  | 長度 | PK  | NULL | 預設值            | 說明              |
| ---------- | --------- | ---- | --- | ---- | ----------------- | ----------------- |
| id         | CHAR      | 36   | Y   | N    | UUID()            | FAQ 唯一識別碼    |
| category   | ENUM      | -    |     | N    | -                 | 問題分類          |
| question   | VARCHAR   | 500  |     | N    | -                 | 問題              |
| answer     | TEXT      | -    |     | N    | -                 | 解答              |
| tags       | JSON      | -    |     | Y    | NULL              | 標籤（JSON 陣列） |
| sort_order | INT       | -    |     | N    | 0                 | 排序順序          |
| is_active  | BOOLEAN   | -    |     | N    | TRUE              | 是否啟用          |
| view_count | INT       | -    |     | N    | 0                 | 檢視次數          |
| created_at | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 建立時間          |
| updated_at | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 更新時間          |

**ENUM 值說明：**

- category: 'booking', 'payment', 'flight', 'refund', 'account', 'general'

**索引：**

- PRIMARY KEY (`id`)
- KEY `idx_faq_category` (`category`)
- KEY `idx_faq_active` (`is_active`)
- KEY `idx_faq_sort` (`sort_order`)

---

### 9. 資料表 booking_modifications（訂單修改記錄表）

**用途：** 記錄訂單修改歷史，支援修改流程追蹤

| 欄位名稱           | 資料型別  | 長度 | PK  | FK  | NULL | 預設值            | 說明                       |
| ------------------ | --------- | ---- | --- | --- | ---- | ----------------- | -------------------------- |
| id                 | CHAR      | 36   | Y   |     | N    | UUID()            | 修改記錄唯一識別碼         |
| booking_id         | CHAR      | 36   |     | Y   | N    | -                 | 訂單 ID（FK: bookings.id） |
| modification_type  | ENUM      | -    |     |     | N    | -                 | 修改類型                   |
| old_flight_id      | CHAR      | 36   |     | Y   | Y    | NULL              | 原航班 ID                  |
| new_flight_id      | CHAR      | 36   |     | Y   | Y    | NULL              | 新航班 ID                  |
| old_passenger_data | JSON      | -    |     |     | Y    | NULL              | 原乘客資料                 |
| new_passenger_data | JSON      | -    |     |     | Y    | NULL              | 新乘客資料                 |
| price_difference   | DECIMAL   | 10,2 |     |     | N    | 0.00              | 價差金額                   |
| modification_fee   | DECIMAL   | 10,2 |     |     | N    | 0.00              | 修改手續費                 |
| reason             | VARCHAR   | 500  |     |     | Y    | NULL              | 修改原因                   |
| status             | ENUM      | -    |     |     | N    | 'pending'         | 修改狀態                   |
| processed_by       | VARCHAR   | 50   |     |     | Y    | NULL              | 處理人員                   |
| created_at         | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 建立時間                   |
| updated_at         | TIMESTAMP | -    |     |     | N    | CURRENT_TIMESTAMP | 更新時間                   |

**ENUM 值說明：**

- modification_type: 'date_change', 'passenger_change', 'flight_change'
- status: 'pending', 'approved', 'rejected', 'completed'

**索引：**

- PRIMARY KEY (`id`)
- KEY `fk_modifications_booking` (`booking_id`)
- KEY `idx_modifications_type` (`modification_type`)
- KEY `idx_modifications_status` (`status`)
- KEY `idx_modifications_created` (`created_at`)

**外鍵約束：**

- FOREIGN KEY (`booking_id`) REFERENCES `bookings`(`id`) ON DELETE CASCADE
- FOREIGN KEY (`old_flight_id`) REFERENCES `flights`(`id`) ON DELETE SET NULL
- FOREIGN KEY (`new_flight_id`) REFERENCES `flights`(`id`) ON DELETE SET NULL

---

### 10. 資料表 system_logs（系統日誌表）

**用途：** 記錄系統操作日誌和錯誤記錄，支援系統錯誤處理流程

| 欄位名稱    | 資料型別  | 長度 | PK  | NULL | 預設值            | 說明           |
| ----------- | --------- | ---- | --- | ---- | ----------------- | -------------- |
| id          | CHAR      | 36   | Y   | N    | UUID()            | 日誌唯一識別碼 |
| log_level   | ENUM      | -    |     | N    | 'INFO'            | 日誌級別       |
| category    | VARCHAR   | 50   |     | N    | -                 | 日誌分類       |
| message     | TEXT      | -    |     | N    | -                 | 日誌訊息       |
| user_id     | CHAR      | 36   |     | Y    | NULL              | 相關用戶 ID    |
| booking_id  | CHAR      | 36   |     | Y    | NULL              | 相關訂單 ID    |
| ip_address  | VARCHAR   | 45   |     | Y    | NULL              | 用戶 IP 位址   |
| user_agent  | VARCHAR   | 500  |     | Y    | NULL              | 用戶代理字串   |
| request_url | VARCHAR   | 500  |     | Y    | NULL              | 請求 URL       |
| stack_trace | TEXT      | -    |     | Y    | NULL              | 錯誤堆疊追蹤   |
| metadata    | JSON      | -    |     | Y    | NULL              | 額外元數據     |
| created_at  | TIMESTAMP | -    |     | N    | CURRENT_TIMESTAMP | 建立時間       |

**ENUM 值說明：**

- log_level: 'DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'

**索引：**

- PRIMARY KEY (`id`)
- KEY `idx_logs_level` (`log_level`)
- KEY `idx_logs_category` (`category`)
- KEY `idx_logs_user` (`user_id`)
- KEY `idx_logs_booking` (`booking_id`)
- KEY `idx_logs_created` (`created_at`)
- KEY `idx_logs_level_created` (`log_level`, `created_at`)

---

## 資料庫初始化腳本

### 建立資料庫

```sql
-- 建立資料庫
CREATE DATABASE kiwi_bird_airline
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

USE kiwi_bird_airline;
```

### 建立資料表（依順序執行）

```sql
-- 1. 建立 users 表
CREATE TABLE users (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    phone_number VARCHAR(15),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    last_login_at TIMESTAMP NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_users_phone (phone_number),
    INDEX idx_users_created_at (created_at)
);

-- 2. 建立 flights 表
CREATE TABLE flights (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    flight_number VARCHAR(10) NOT NULL UNIQUE,
    departure_airport VARCHAR(3) NOT NULL,
    arrival_airport VARCHAR(3) NOT NULL,
    departure_time DATETIME NOT NULL,
    arrival_time DATETIME NOT NULL,
    aircraft_model VARCHAR(50),
    total_seats INT NOT NULL,
    available_seats INT NOT NULL,
    base_price DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    status ENUM('scheduled', 'boarding', 'departed', 'arrived', 'cancelled', 'delayed') NOT NULL DEFAULT 'scheduled',
    gate VARCHAR(10),
    terminal VARCHAR(10),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_flights_departure (departure_airport, departure_time),
    INDEX idx_flights_route (departure_airport, arrival_airport),
    INDEX idx_flights_status (status)
);

-- 3. 建立 passengers 表
CREATE TABLE passengers (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    passport_number VARCHAR(20) NOT NULL,
    date_of_birth DATE NOT NULL,
    nationality VARCHAR(2) NOT NULL,
    gender ENUM('M', 'F', 'OTHER'),
    email VARCHAR(100),
    phone_number VARCHAR(15),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_passengers_passport (passport_number),
    INDEX idx_passengers_name (first_name, last_name)
);

-- 4. 建立 bookings 表
CREATE TABLE bookings (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    booking_number VARCHAR(20) NOT NULL UNIQUE,
    user_id CHAR(36) NOT NULL,
    flight_id CHAR(36) NOT NULL,
    status ENUM('pending', 'confirmed', 'cancelled', 'modified', 'completed') NOT NULL DEFAULT 'pending',
    passenger_count INT NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    contact_email VARCHAR(100) NOT NULL,
    contact_phone VARCHAR(15) NOT NULL,
    booking_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    confirmation_code VARCHAR(10),
    notes TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_bookings_status (status),
    INDEX idx_bookings_date (booking_date),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (flight_id) REFERENCES flights(id) ON DELETE RESTRICT
);

-- 5. 建立 booking_passengers 表
CREATE TABLE booking_passengers (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    booking_id CHAR(36) NOT NULL,
    passenger_id CHAR(36) NOT NULL,
    seat_number VARCHAR(5),
    ticket_number VARCHAR(15),
    check_in_time TIMESTAMP NULL,
    boarding_pass VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_booking_passenger (booking_id, passenger_id),
    INDEX idx_booking_passengers_ticket (ticket_number),
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE,
    FOREIGN KEY (passenger_id) REFERENCES passengers(id) ON DELETE RESTRICT
);

-- 6. 建立 payments 表
CREATE TABLE payments (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    booking_id CHAR(36) NOT NULL UNIQUE,
    transaction_id VARCHAR(50),
    payment_method ENUM('credit_card', 'debit_card', 'atm_transfer', 'bank_transfer') NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'TWD',
    status ENUM('pending', 'processing', 'completed', 'failed', 'cancelled', 'refunded') NOT NULL DEFAULT 'pending',
    gateway_response JSON,
    card_last_four VARCHAR(4),
    card_brand VARCHAR(20),
    processed_at TIMESTAMP NULL,
    refunded_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    refunded_at TIMESTAMP NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_payments_transaction (transaction_id),
    INDEX idx_payments_status (status),
    INDEX idx_payments_method (payment_method),
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE RESTRICT
);

-- 7. 建立 support_tickets 表
CREATE TABLE support_tickets (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    ticket_number VARCHAR(20) NOT NULL UNIQUE,
    user_id CHAR(36),
    booking_id CHAR(36),
    category ENUM('booking', 'payment', 'flight', 'refund', 'technical', 'general') NOT NULL,
    subject VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    priority ENUM('low', 'medium', 'high', 'urgent') NOT NULL DEFAULT 'medium',
    status ENUM('open', 'in_progress', 'waiting_customer', 'resolved', 'closed') NOT NULL DEFAULT 'open',
    assigned_agent VARCHAR(50),
    contact_name VARCHAR(100) NOT NULL,
    contact_email VARCHAR(100) NOT NULL,
    contact_phone VARCHAR(15),
    resolution TEXT,
    resolved_at TIMESTAMP NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_tickets_status (status),
    INDEX idx_tickets_category (category),
    INDEX idx_tickets_priority (priority),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE SET NULL
);

-- 8. 建立 faq 表
CREATE TABLE faq (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    category ENUM('booking', 'payment', 'flight', 'refund', 'account', 'general') NOT NULL,
    question VARCHAR(500) NOT NULL,
    answer TEXT NOT NULL,
    tags JSON,
    sort_order INT NOT NULL DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    view_count INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_faq_category (category),
    INDEX idx_faq_active (is_active),
    INDEX idx_faq_sort (sort_order)
);

-- 9. 建立 booking_modifications 表
CREATE TABLE booking_modifications (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    booking_id CHAR(36) NOT NULL,
    modification_type ENUM('date_change', 'passenger_change', 'flight_change') NOT NULL,
    old_flight_id CHAR(36),
    new_flight_id CHAR(36),
    old_passenger_data JSON,
    new_passenger_data JSON,
    price_difference DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    modification_fee DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    reason VARCHAR(500),
    status ENUM('pending', 'approved', 'rejected', 'completed') NOT NULL DEFAULT 'pending',
    processed_by VARCHAR(50),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX fk_modifications_booking (booking_id),
    INDEX idx_modifications_type (modification_type),
    INDEX idx_modifications_status (status),
    INDEX idx_modifications_created (created_at),

    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE,
    FOREIGN KEY (old_flight_id) REFERENCES flights(id) ON DELETE SET NULL,
    FOREIGN KEY (new_flight_id) REFERENCES flights(id) ON DELETE SET NULL
);

-- 10. 建立 system_logs 表
CREATE TABLE system_logs (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    log_level ENUM('DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL') NOT NULL DEFAULT 'INFO',
    category VARCHAR(50) NOT NULL,
    message TEXT NOT NULL,
    user_id CHAR(36),
    booking_id CHAR(36),
    ip_address VARCHAR(45),
    user_agent VARCHAR(500),
    request_url VARCHAR(500),
    stack_trace TEXT,
    metadata JSON,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_logs_level (log_level),
    INDEX idx_logs_category (category),
    INDEX idx_logs_user (user_id),
    INDEX idx_logs_booking (booking_id),
    INDEX idx_logs_created (created_at),
    INDEX idx_logs_level_created (log_level, created_at)
);
```

---

## 資料庫維護

### 定期維護作業

1. **索引優化：** 定期檢查並重建索引
2. **資料清理：** 清理過期的暫存資料
3. **備份策略：** 每日備份，保留 30 天
4. **效能監控：** 監控慢查詢並優化

### 資料保留政策

- **用戶資料：** 帳戶刪除後保留 1 年（法規要求）
- **訂單資料：** 永久保留（會計需求）
- **客服工單：** 結案後保留 3 年
- **系統日誌：** 保留 6 個月

---

✏️ _最後更新時間：2025-07-17_
